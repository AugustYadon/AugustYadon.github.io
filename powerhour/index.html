<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Auggo's Power Hour</title>

    <!-- bootstrap.min.css -->
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/styles.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->



  </head>

  <body>
  <input type="button" value="skiptotwenty" onclick="skiptotwenty();">
  <input type="button" value="get_info" onclick="getinfo();">
  <input type="button" value="log info" onclick="loginfo();">



    <div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><span>Auggo's Power Hour</span></a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="#">Home</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
        <h1>Auggo's Power hour</h1>
        <p class="lead">This website looks great.</p>
      </div>

      <!-- ko ifnot: isLoggedIn -->
      <div id="login">
        <div data-bind="if: loginErrorMessage">
          <div class="alert alert-danger" data-bind="text: loginErrorMessage"></div>
        </div>
        <button id="login-button" class="btn btn-primary" data-bind="click: login">Log in with Spotify</button>
      </div>
      <!-- /ko -->

      <!-- ko if: isLoggedIn -->
      <div id="loggedin">
        <div data-bind="with: user">
          <h1>Logged in as <span data-bind="text: display_name"></span></h1>
          <img data-bind="attr: {src: images[0].url}">

        </div>

        <hr />

        <h2>My playlists</h2>
        <ul data-bind="foreach: playlists">
          <li class="media playlist">
            <div class="media-left">
              <img data-bind="attr: {src: images.length ? images[0].url : ''}" width="200" height="200" />
            </div>
            <div class="media-body">
              <div class="media-heading" data-bind="text:name"></div>
              <input type="button" value="Begin New Power Hour" onclick="beginPowerHour('spotify:track:1qV7xk7miGq7WaZzdaF2U9');">
               <input type="button" value="Clear Power Hour" onclick="pausePowerHour();">
            </div>
          </li>
        </ul>

        <button id="login-button" class="btn btn-primary" data-bind="click: logout">Log out from Spotify</button>
      </div>
      <!-- /ko -->
    </div>

    <!-- jQuery required for Bootstrap core JavaScript -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <!-- This file would be available as a vendor dependency in your local project if you're using Bower or Composer -->
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/knockout/dist/knockout.js"></script>
    <script src="bower_components/spotify-web-api-js/src/spotify-web-api.js"></script>
    <script src="js/oauth-config.js"></script>
    <script src="js/oauth-manager.js"></script>
    <script src="js/main.js"></script>

    <script type="text/javascript">
      var player;
      window.onSpotifyWebPlaybackSDKReady = () => {
        var tok = localStorage.getItem('sp-access-token');
        player = new Spotify.Player({
          name: 'Web Playback SDK Quick Start Player',
          getOAuthToken: cb => { cb(tok); }
        });

        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        player.addListener('player_state_changed', state => { console.log(state); });

        // Ready
        player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);
        });

        // Not Ready
        player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
        });

        // Connect to the player!
        player.connect();


        // play({
        //   playerInstance: player,
        //   spotify_uri: 'spotify:track:1qV7xk7miGq7WaZzdaF2U9',
        // });

      };





      const play = ({
        spotify_uri,
        playerInstance: {
          _options: {
            getOAuthToken
          }
        }
      }) => {
        getOAuthToken(access_token => {
          fetch('https://api.spotify.com/v1/me/player/play', {
            method: 'PUT',
            body: JSON.stringify({ uris: [spotify_uri] }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${access_token}`
            },
          });
        });
      };

      function getOAuthToken(){return localStorage.getItem('sp-access-token');}




      var pausednow = false;
      function pausebutton(){
        pausednow = !pausednow;
        if(pausednow){
          player.pause().then(() => {
            console.log('Resumed!');
          });
        }
        else{ 
          player.resume().then(() => {
            console.log('Resumed!');
          });
        }
      } 

      function SkipToNextSong(){
        var tok = localStorage.getItem('sp-access-token');
        fetch("https://api.spotify.com/v1/me/player/next", {
          method: 'POST',
          headers: {Authorization: 'Bearer '+tok}
        });
      }



      function skiptotwenty(){
        var tok = localStorage.getItem('sp-access-token');
        fetch("https://api.spotify.com/v1/me/player/seek?position_ms=25000", {
          method: 'PUT',
          'Accept': 'application/json',
          headers: {'Content-Type': 'application/json',
          Authorization: 'Bearer '+tok}
        });
      }
      var current_info;

      function getinfo(){
        var tok = localStorage.getItem('sp-access-token');
          fetch("https://api.spotify.com/v1/me/player", {
            method: 'GET',
            'Accept': 'application/json',
            headers: {'Content-Type': 'application/json',
            Authorization: 'Bearer '+tok}
          }).then(response => response.json())
            .then(data => { current_info = data;
          });
      }

      function loginfo(){console.log(current_info)}

      var skipper;

      function beginPowerHour(spotify_uris)
      {
        skipper = setInterval(function(){ SkipToNextSong(); }, 60000);
        
        // play({
        //   playerInstance: player,
        //   spotify_uri: spotify_uris,
        // });
      }

      function pausePowerHour(){
        clearInterval(skipper);
      }


    </script>

    <script src="js/spotify-player.js"></script>
  </body>
</html>
